name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyinstaller
          pip install -r requirements.txt

      - name: Install UPX (for compression)
        run: |
          choco install upx -y

      - name: Build Windows executable
        run: |
          pyinstaller --name="KOOI-Cut" --windowed --onefile ^
            --icon=assets/icon.ico ^
            --add-data="assets;assets" ^
            --copy-metadata imageio ^
            --copy-metadata moviepy ^
            --copy-metadata numpy ^
            --exclude-module PySide2 ^
            --exclude-module PySide6 ^
            --exclude-module PyQt5 ^
            --exclude-module PyQt6.QtWebEngine ^
            --exclude-module PyQt6.QtTest ^
            --exclude-module PyQt6.QtBluetooth ^
            --exclude-module PyQt6.QtNfc ^
            --exclude-module PyQt6.QtPositioning ^
            --exclude-module PyQt6.QtSensors ^
            --exclude-module PyQt6.Qt3D ^
            --exclude-module PyQt6.QtQuick ^
            --exclude-module PyQt6.QtQml ^
            --exclude-module matplotlib ^
            --exclude-module scipy ^
            --exclude-module pandas ^
            --exclude-module PIL.ImageQt ^
            modern_gui.py

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: KOOI-Cut-Windows
          path: dist/KOOI-Cut.exe

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyinstaller
          pip install -r requirements.txt

      - name: Install UPX (for compression)
        run: |
          brew install upx

      - name: Build macOS app
        run: |
          pyinstaller --name="KOOI-Cut" --windowed --onefile \
            --icon=assets/icon.icns \
            --add-data="assets:assets" \
            --copy-metadata imageio \
            --copy-metadata moviepy \
            --copy-metadata numpy \
            --exclude-module PySide2 \
            --exclude-module PySide6 \
            --exclude-module PyQt5 \
            --exclude-module PyQt6.QtWebEngine \
            --exclude-module PyQt6.QtTest \
            --exclude-module PyQt6.QtBluetooth \
            --exclude-module PyQt6.QtNfc \
            --exclude-module PyQt6.QtPositioning \
            --exclude-module PyQt6.QtSensors \
            --exclude-module PyQt6.Qt3D \
            --exclude-module PyQt6.QtQuick \
            --exclude-module PyQt6.QtQml \
            --exclude-module matplotlib \
            --exclude-module scipy \
            --exclude-module pandas \
            --exclude-module PIL.ImageQt \
            modern_gui.py

      - name: Create DMG
        run: |
          brew install create-dmg
          create-dmg --volname "KOOI Cut" --window-pos 200 120 --window-size 800 400 --icon-size 100 --app-drop-link 600 185 "KOOI-Cut.dmg" "dist/KOOI-Cut.app"

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: KOOI-Cut-macOS
          path: KOOI-Cut.dmg

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          df -h

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev fakeroot python3-pyqt6 upx-ucl
          pip install pyinstaller
          pip install -r requirements.txt

      - name: Build Linux executable
        run: |
          pyinstaller --name="KOOI-Cut" --onefile \
            --add-data="assets:assets" \
            --copy-metadata imageio \
            --copy-metadata moviepy \
            --copy-metadata numpy \
            --exclude-module PySide2 \
            --exclude-module PySide6 \
            --exclude-module PyQt5 \
            --exclude-module PyQt6.QtWebEngine \
            --exclude-module PyQt6.QtTest \
            --exclude-module PyQt6.QtBluetooth \
            --exclude-module PyQt6.QtNfc \
            --exclude-module PyQt6.QtPositioning \
            --exclude-module PyQt6.QtSensors \
            --exclude-module PyQt6.Qt3D \
            --exclude-module PyQt6.QtQuick \
            --exclude-module PyQt6.QtQml \
            --exclude-module matplotlib \
            --exclude-module scipy \
            --exclude-module pandas \
            --exclude-module PIL.ImageQt \
            modern_gui.py

      - name: Create AppImage
        run: |
          # 复制图标文件以匹配desktop文件中的Icon字段
          cp assets/icon.png assets/kooix-cut.png
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --executable dist/KOOI-Cut --desktop-file assets/kooix-cut.desktop --icon-file assets/kooix-cut.png --output appimage

      - name: Build DEB package
        run: |
          mkdir -p kooix-cut_0.2.4/DEBIAN
          mkdir -p kooix-cut_0.2.4/usr/bin
          mkdir -p kooix-cut_0.2.4/usr/share/applications
          mkdir -p kooix-cut_0.2.4/usr/share/icons/hicolor/512x512/apps

          cp dist/KOOI-Cut kooix-cut_0.2.4/usr/bin/
          cp assets/kooix-cut.desktop kooix-cut_0.2.4/usr/share/applications/
          cp assets/icon.png kooix-cut_0.2.4/usr/share/icons/hicolor/512x512/apps/kooix-cut.png

          cat > kooix-cut_0.2.4/DEBIAN/control << EOF
          Package: kooix-cut
          Version: 0.2.4
          Section: video
          Priority: optional
          Architecture: amd64
          Depends: python3, python3-pyqt6
          Maintainer: KOOI <kooi@example.com>
          Description: 智能视频剪辑预处理工具
           自动合并视频并删除静音片段，支持 AI 增强检测。
          EOF

          chmod 755 kooix-cut_0.2.4/usr/bin/KOOI-Cut
          dpkg-deb --build kooix-cut_0.2.4

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: KOOI-Cut-Linux
          path: |
            KOOI_Cut-x86_64.AppImage
            kooix-cut_0.2.4.deb

  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            KOOI-Cut-Windows/KOOI-Cut.exe
            KOOI-Cut-macOS/KOOI-Cut.dmg
            KOOI-Cut-Linux/KOOI_Cut-x86_64.AppImage
            KOOI-Cut-Linux/kooix-cut_0.2.4.deb
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
